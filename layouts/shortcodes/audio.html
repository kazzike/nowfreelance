<div class="audio-player-wrapper">
    <audio controls controlslist="nodownload" preload="metadata" id="audio-{{ .Ordinal }}">
        {{ with .Get "opus" }}
        <source src="{{ . }}" type="audio/ogg; codecs=opus">{{ end }}
        {{ with .Get "mp3" }}
        <source src="{{ . }}" type="audio/mpeg">{{ end }}
        Your browser does not support the audio element.
    </audio>
    <div class="audio-duration" id="duration-{{ .Ordinal }}" style="font-size: 0.9em; margin-top: 5px; color: #666;">
        Loading duration...
    </div>
    <script>
        (function () {
            const audio = document.getElementById('audio-{{ .Ordinal }}');
            const durationDisplay = document.getElementById('duration-{{ .Ordinal }}');

            function formatTime(seconds) {
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `Duration: ${m}m ${s}s`;
            }

            function updateDuration() {
                const duration = audio.duration;
                // Check if duration is a valid finite number
                if (!isNaN(duration) && isFinite(duration) && duration > 0) {
                    durationDisplay.textContent = formatTime(duration);
                } else {
                    // If duration is still loading or Infinity, we might need to wait
                    // console.log('Duration not ready:', duration);
                }
            }

            // 'durationchange' is more reliable than 'loadedmetadata' for variable encoding or streaming
            audio.addEventListener('durationchange', updateDuration);
            audio.addEventListener('loadedmetadata', updateDuration);

            // Fallback: Check immediately in case it's already loaded
            if (audio.readyState >= 1) {
                updateDuration();
            }
        })();
    </script>
</div>