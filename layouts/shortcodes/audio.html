<div class="audio-player-wrapper">
    <audio controls controlslist="nodownload" preload="metadata" id="audio-{{ .Ordinal }}">
        {{ with .Get "opus" }}
        <source src="{{ . }}" type="audio/ogg; codecs=opus">{{ end }}
        {{ with .Get "mp3" }}
        <source src="{{ . }}" type="audio/mpeg">{{ end }}
        Your browser does not support the audio element.
    </audio>
    <div class="audio-duration" id="duration-{{ .Ordinal }}" style="font-size: 0.9em; margin-top: 5px; color: #666;">
        Loading duration...
    </div>
    <script>
        (function () {
            const audio = document.getElementById('audio-{{ .Ordinal }}');
            const durationDisplay = document.getElementById('duration-{{ .Ordinal }}');
            let checkInterval;

            function formatTime(seconds) {
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `Duration: ${m}m ${s}s`;
            }

            function updateDuration() {
                const duration = audio.duration;
                if (!isNaN(duration) && isFinite(duration) && duration > 0) {
                    durationDisplay.textContent = formatTime(duration);
                    // Clear the interval once we have a valid duration
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                    return true;
                }
                return false;
            }

            // Multiple event listeners for better compatibility
            audio.addEventListener('durationchange', updateDuration);
            audio.addEventListener('loadedmetadata', updateDuration);
            audio.addEventListener('loadeddata', updateDuration);
            audio.addEventListener('canplay', updateDuration);

            // Force load metadata
            audio.load();

            // Immediate check
            if (!updateDuration()) {
                // Polling fallback: check every 100ms for up to 5 seconds
                let attempts = 0;
                checkInterval = setInterval(() => {
                    attempts++;
                    if (updateDuration() || attempts > 50) {
                        clearInterval(checkInterval);
                        if (attempts > 50) {
                            durationDisplay.textContent = 'Duration unavailable';
                        }
                    }
                }, 100);
            }
        })();
    </script>
</div>